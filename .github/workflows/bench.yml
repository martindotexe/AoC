on:
  push:
    paths-ignore:
      - "**.md"
      - "assets/**"
      - "LICENSE"
      - ".gitignore"
      - ".gitattributes"
      - "docs/**"
    branches: [ main ]
  workflow_dispatch:

jobs:
  discover-python:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover Python solutions
        id: set-matrix
        run: |
          solutions=$(find solutions/py -type f -name "main.py" | while read file; do
            year=$(echo $file | sed -n 's|solutions/py/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/main.py|\1|p')
            day=$(echo $file | sed -n 's|solutions/py/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/main.py|\2|p')
            # Remove leading zeros from day
            day=$((10#$day))
            echo "{\"year\":\"$year\",\"day\":\"$day\"}"
          done | jq -s -c '.')
          echo "matrix=$solutions" >> $GITHUB_OUTPUT
          echo "Found solutions: $solutions"

  discover-go:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover Go solutions
        id: set-matrix
        run: |
          solutions=$(find solutions/go -type f -name "main.go" | while read file; do
            year=$(echo $file | sed -n 's|solutions/go/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/main.go|\1|p')
            day=$(echo $file | sed -n 's|solutions/go/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/main.go|\2|p')
            # Remove leading zeros from day
            day=$((10#$day))
            echo "{\"year\":\"$year\",\"day\":\"$day\"}"
          done | jq -s -c '.')
          echo "matrix=$solutions" >> $GITHUB_OUTPUT
          echo "Found solutions: $solutions"

  discover-ts:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover TypeScript solutions
        id: set-matrix
        run: |
          solutions=$(find solutions/ts -type f -name "index.ts" | while read file; do
            year=$(echo $file | sed -n 's|solutions/ts/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/index.ts|\1|p')
            day=$(echo $file | sed -n 's|solutions/ts/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/index.ts|\2|p')
            # Remove leading zeros from day
            day=$((10#$day))
            echo "{\"year\":\"$year\",\"day\":\"$day\"}"
          done | jq -s -c '.')
          echo "matrix=$solutions" >> $GITHUB_OUTPUT
          echo "Found solutions: $solutions"

  bench-python:
    needs: discover-python
    runs-on: ubuntu-latest
    strategy:
      matrix:
        py: ${{ fromJson(needs.discover-python.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Earthly
        uses: earthly/actions/setup-earthly@v1
        with:
          version: latest

      - name: Run benchmark for Python ${{ matrix.py.year }} day ${{ matrix.py.day }}
        run: earthly --ci --output --secret AOC_SESSION="${{ secrets.AOC_SESSION }}" +pypy --year=${{ matrix.py.year }} --day=${{ matrix.py.day }}

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-py-${{ matrix.py.year }}-${{ matrix.py.day }}
          path: results/
          retention-days: 1

  bench-go:
    needs: discover-go
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go: ${{ fromJson(needs.discover-go.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Earthly
        uses: earthly/actions/setup-earthly@v1
        with:
          version: latest

      - name: Run benchmark for Go ${{ matrix.go.year }} day ${{ matrix.go.day }}
        run: earthly --ci --output --secret AOC_SESSION="${{ secrets.AOC_SESSION }}" +go --year=${{ matrix.go.year }} --day=${{ matrix.go.day }}

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-go-${{ matrix.go.year }}-${{ matrix.go.day }}
          path: results/
          retention-days: 1

  bench-typescript:
    needs: discover-ts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ts: ${{ fromJson(needs.discover-ts.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Earthly
        uses: earthly/actions/setup-earthly@v1
        with:
          version: latest

      - name: Run benchmark for TypeScript ${{ matrix.ts.year }} day ${{ matrix.ts.day }}
        run: earthly --ci --output --secret AOC_SESSION="${{ secrets.AOC_SESSION }}" +bun --year=${{ matrix.ts.year }} --day=${{ matrix.ts.day }}

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-ts-${{ matrix.ts.year }}-${{ matrix.ts.day }}
          path: results/
          retention-days: 1

  merge-benchmarks:
    needs: [bench-python, bench-go, bench-typescript]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Merge all benchmark results
        uses: actions/upload-artifact/merge@v4
        with:
          name: benchmarks
          pattern: benchmark-*
          separate-directories: false
          delete-merged: true
          retention-days: 30

  update-readme:
    needs: merge-benchmarks
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download benchmark results
        uses: actions/download-artifact@v4
        with:
          name: benchmarks
          path: benchmarks/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update README with benchmarks
        run: python update_readme.py benchmarks/

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update README with latest benchmark results" && git push)
