on:
  push:
    paths-ignore:
      - "*.md"
      - "LICENSE"
      - ".gitignore"
      - ".gitattributes"
      - "update_readme.py"
    branches: [ main ]
  workflow_dispatch:

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover all solutions
        id: set-matrix
        run: |
          solutions=$(
            # Python solutions
            find solutions/py -type f -name "main.py" | while read file; do
              year=$(echo $file | sed -n 's|solutions/py/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/main.py|\1|p')
              day=$(echo $file | sed -n 's|solutions/py/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/main.py|\2|p')
              day=$((10#$day))
              echo "{\"lang\":\"py\",\"target\":\"pypy\",\"year\":\"$year\",\"day\":\"$day\",\"file\":\"$file\"}"
            done
            # Go solutions
            find solutions/go -type f -name "main.go" | while read file; do
              year=$(echo $file | sed -n 's|solutions/go/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/main.go|\1|p')
              day=$(echo $file | sed -n 's|solutions/go/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/main.go|\2|p')
              day=$((10#$day))
              echo "{\"lang\":\"go\",\"target\":\"go\",\"year\":\"$year\",\"day\":\"$day\",\"file\":\"$file\"}"
            done
            # TypeScript solutions
            find solutions/ts -type f -name "index.ts" | while read file; do
              year=$(echo $file | sed -n 's|solutions/ts/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/index.ts|\1|p')
              day=$(echo $file | sed -n 's|solutions/ts/\([0-9]\{4\}\)/day\([0-9]\{2\}\)/index.ts|\2|p')
              day=$((10#$day))
              echo "{\"lang\":\"ts\",\"target\":\"bun\",\"year\":\"$year\",\"day\":\"$day\",\"file\":\"$file\"}"
            done
          )
          matrix=$(echo "$solutions" | jq -s -c '.')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Found solutions: $matrix"

  bench:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      matrix:
        solution: ${{ fromJson(needs.discover.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Compute solution hash
        id: solution-hash
        run: |
          FILE="${{ matrix.solution.file }}"
          HASH=$(sha256sum "$FILE" | awk '{print $1}' | cut -c1-16)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "Solution file: $FILE"
          echo "Hash: $HASH"

      - name: Restore cached benchmark
        id: cache-benchmark
        uses: actions/cache@v4
        with:
          path: results/
          key: benchmark-${{ matrix.solution.lang }}-${{ matrix.solution.year }}-${{ matrix.solution.day }}-${{ steps.solution-hash.outputs.hash }}

      - name: Restore AOC input cache
        if: steps.cache-benchmark.outputs.cache-hit != 'true'
        id: cache-aoc-input
        uses: actions/cache@v4
        with:
          path: aoc-inputs/
          key: aoc-input-${{ matrix.solution.year }}-${{ matrix.solution.day }}

      - name: Cache status summary
        run: |
          echo "=== Cache Status ==="
          if [ "${{ steps.cache-benchmark.outputs.cache-hit }}" == "true" ]; then
            echo "✓ Benchmark cache HIT - using cached results"
            echo "  Cache key: benchmark-${{ matrix.solution.lang }}-${{ matrix.solution.year }}-${{ matrix.solution.day }}-${{ steps.solution-hash.outputs.hash }}"
          else
            echo "✗ Benchmark cache MISS - will run fresh benchmark"
            if [ "${{ steps.cache-aoc-input.outputs.cache-hit }}" == "true" ]; then
              echo "✓ AOC input cache HIT - using cached input"
            else
              echo "✗ AOC input cache MISS - will download from AOC"
            fi
          fi
          echo "==================="

      - name: Download AOC input
        if: steps.cache-benchmark.outputs.cache-hit != 'true' && steps.cache-aoc-input.outputs.cache-hit != 'true'
        run: |
          YEAR=${{ matrix.solution.year }}
          DAY=${{ matrix.solution.day }}
          mkdir -p aoc-inputs
          echo "Downloading AOC input for $YEAR day $DAY..."
          curl -f -b "session=${{ secrets.AOC_SESSION }}" \
            "https://adventofcode.com/$YEAR/day/$DAY/input" \
            -o "aoc-inputs/$YEAR-$DAY.txt"
          echo "✓ Downloaded successfully"

      - name: Setup Earthly
        if: steps.cache-benchmark.outputs.cache-hit != 'true'
        uses: earthly/actions/setup-earthly@v1
        with:
          version: latest

      - name: Run benchmark for ${{ matrix.solution.lang }} ${{ matrix.solution.year }} day ${{ matrix.solution.day }}
        if: steps.cache-benchmark.outputs.cache-hit != 'true'
        run: earthly --ci --output --secret AOC_SESSION="${{ secrets.AOC_SESSION }}" +${{ matrix.solution.target }} --year=${{ matrix.solution.year }} --day=${{ matrix.solution.day }}

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ matrix.solution.lang }}-${{ matrix.solution.year }}-${{ matrix.solution.day }}
          path: results/
          retention-days: 1

  merge-benchmarks:
    needs: bench
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Merge all benchmark results
        uses: actions/upload-artifact/merge@v4
        with:
          name: benchmarks
          pattern: benchmark-*
          separate-directories: false
          delete-merged: true
          retention-days: 30

  update-readme:
    needs: merge-benchmarks
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download benchmark results
        uses: actions/download-artifact@v4
        with:
          name: benchmarks
          path: benchmarks/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update README with benchmarks
        run: python update_readme.py benchmarks/ --session ${{ secrets.AOC_SESSION }}

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update README with latest benchmark results" && git push)
