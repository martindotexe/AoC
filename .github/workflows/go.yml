# .github/workflows/test.yml
name: Tests

on:
  push:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Download dependencies
      run: go mod download

    - name: Fetch Puzzle Inputs
      run: |
        fetch_input() {
          local year=$1
          local day=$2
          local day_padded=$(printf "%02d" $day)
          local dir="${year}/day${day_padded}"

          if [ ! -d "$dir" ]; then return; fi
          if [ -f "${dir}/solution.go" ]; then
            echo "ℹ️ Found solution for ${year} day ${day}"
            curl "https://adventofcode.com/${year}/day/${day}/input" \
              -H "Cookie: session=${AOC_SESSION}" \
              -o "${dir}/in.txt" --silent --show-error
            sleep 1
          fi
        }

        # Look for year directories using simple pattern match
        for dir in *; do
          if [ -d "$dir" ] && [[ "$dir" =~ ^20[0-9][0-9]$ ]]; then  # Match 2000-2099
            year="$dir"
            echo "✅ Detected valid year directory: $year"
            for day in {1..25}; do
              fetch_input "$year" "$day"
            done
          else
            echo "⚠️ Skipping non-year directory/file: $dir"
          fi
        done
      env:
        AOC_SESSION: ${{ secrets.AOC_SESSION }}

    - name: Test
      run: go test ./...
      
    - name: Run benchmarks
      run: go test -bench=. -benchmem ./...
